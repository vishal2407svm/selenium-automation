name: DAMS Mentor Booking Automation

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      phone_number:
        description: 'Phone Number (with country code)'
        required: true
        default: '+919411611466'
      otp:
        description: 'OTP Code'
        required: true
        default: '2000'
      number_of_bookings:
        description: 'Number of bookings to make'
        required: true
        default: '5'
  
  schedule:
    - cron: '0 6 * * *'  # Runs daily at 6 AM UTC (11:30 AM IST)

jobs:
  dams-automation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'  # Updated to 17 (Better for newer Selenium)
          distribution: 'temurin'
      
      - name: Check Chrome Version (Debug)
        run: |
          google-chrome --version
          chromedriver --version
          which chromedriver
      
      - name: Download Selenium Libraries
        run: |
          mkdir -p libs
          # Downloading Selenium 4.16.1 (Stable)
          wget -q https://github.com/SeleniumHQ/selenium/releases/download/selenium-4.16.0/selenium-java-4.16.1.zip
          unzip -o selenium-java-4.16.1.zip
          
          # Flatten the JARs into one folder for easier classpath
          cp selenium-java-4.16.1/*.jar libs/
          cp selenium-java-4.16.1/lib/*.jar libs/
          
          echo "‚úÖ Dependencies downloaded. JAR count:"
          ls libs/*.jar | wc -l
      
      - name: Check if DAMSMentor.java exists
        run: |
          if [ ! -f "DAMSMentor.java" ]; then
            echo "‚ùå ERROR: DAMSMentor.java not found!"
            ls -la
            exit 1
          fi
      
      - name: Update configuration (Manual Trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "üìù Updating configuration..."
          sed -i 's/private static final String PHONE_NUMBER = ".*";/private static final String PHONE_NUMBER = "${{ github.event.inputs.phone_number }}";/' DAMSMentor.java
          sed -i 's/private static final String OTP = ".*";/private static final String OTP = "${{ github.event.inputs.otp }}";/' DAMSMentor.java
          sed -i 's/private static final int NUMBER_OF_BOOKINGS = .*;/private static final int NUMBER_OF_BOOKINGS = ${{ github.event.inputs.number_of_bookings }};/' DAMSMentor.java
      
      - name: Update configuration (Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "üìù Updating configuration from Secrets..."
          sed -i 's/private static final String PHONE_NUMBER = ".*";/private static final String PHONE_NUMBER = "${{ secrets.PHONE_NUMBER }}";/' DAMSMentor.java
          sed -i 's/private static final String OTP = ".*";/private static final String OTP = "${{ secrets.OTP }}";/' DAMSMentor.java
      
      - name: Compile Java code
        run: |
          javac -cp ".:libs/*" DAMSMentor.java
      
      - name: Run automation
        run: |
          # Using xvfb just in case, though headless is set in Java
          xvfb-run java -cp ".:libs/*" DAMSMentor
        timeout-minutes: 60
      
      - name: Upload Artifacts (Screenshots & Report)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-artifacts
          path: |
            screenshots/
            *.html
          retention-days: 5
