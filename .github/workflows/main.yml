name: Run DAMS Parallel Java Test (Auto)

# Triggers: Manual, On Push (Automatic), and Scheduled (Automatic)
on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ "main" ] # Runs automatically when code is pushed to 'main'
  schedule:
    - cron: '0 0 * * *' # Runs automatically every day at midnight UTC

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out your repository's code
      - name: Check out code
        uses: actions/checkout@v4

      # 2. Set up Java (JDK 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Set up Chrome
      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # 4. Create a 'lib' directory
      - name: Create lib directory
        run: mkdir -p lib

      # 5. Download Dependencies (Selenium + Commons IO)
      - name: Download JAR dependencies
        run: |
          echo "Downloading Selenium Server..."
          curl -L -o lib/selenium-server.jar "https://github.com/SeleniumHQ/selenium/releases/download/selenium-4.21.0/selenium-server-4.21.0.jar"
          
          echo "Downloading Commons IO (Fix for FileUtils error)..."
          curl -L -o lib/commons-io.jar "https://repo1.maven.org/maven2/commons-io/commons-io/2.14.0/commons-io-2.14.0.jar"
          
          echo "Download complete. Listing lib folder:"
          ls -lh lib/

      # 6. Compile the Java file
      # FIX: Added commons-io.jar to the classpath separator (:)
      - name: Compile Java code
        run: |
          javac -cp "lib/selenium-server.jar:lib/commons-io.jar" DAMSParallel.java
          echo "Compile complete."
          ls -l *.class

      # 7. Run the compiled Java class
      # FIX: Added commons-io.jar to the classpath
      - name: Run Java test
        run: |
          java -cp ".:lib/selenium-server.jar:lib/commons-io.jar" DAMSParallel

      # 8. Upload Screenshots Artifact
      - name: Upload screenshots artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qr-code-screenshots
          path: screenshots/
          retention-days: 7

      # 9. Upload HTML Report Artifact
      - name: Upload HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: DAMS_Parallel_Report_*.html # Use wildcard to find the report
          retention-days: 7